/* tvw_o test case for test05o.tvw
 * AGPL-3.0 license
 * Initial rev 2023-11-09 Misha Turnbull
 *
 * Tests the tvw_o functions on the case of teest05.tvw.
 */

#include "../unittest.h"
#include "tvwio/tvw_o.h"
#include "tvwio/tvw_i.h"

/**
 * Holds test data for case test05o.tvw.
 *
 * Used to pass data from setup functions, to the test case, and then to the
 * teardown function.
 */
struct test05o {
    struct WRAPPER_FILE *file;
    int err;
} test05o;

/**
 * Pre-test setup function for test05o.tvw test case.
 *
 * Called before every test case to ensure they start from the same point.
 */
static void setup(void) {
    test05o.file = (struct WRAPPER_FILE*)calloc(
            1, sizeof(struct WRAPPER_FILE));
    int err = read_wrapper("test/resources/test05.tvw", test05o.file);

    cr_assert(eq(int, err, 0),
            "test05.tvw could not be read, no further actions reasonable!");

    strcpy(test05o.file->filename, "test/resources/test00.dne");

    // clear out the file before we do anything
    // this way we can be sure any contents are a result of tvw_o functions
    fclose(fopen(test05o.file->filename, "w"));

    test05o.err = tvw_write(test05o.file);
}

/**
 * Post-test teardown function for test05o.tvw test case.
 *
 * Called after every test case to ensure they end cleanly.
 */
static void teardown(void) {
    // clear out the file after we (potentially) wrote to it
    fclose(fopen(test05o.file->filename, "w"));
    tvwfree(test05o.file);
}

/**
 * Declare test case for test05o.tvw, using the defined setup and teardown
 * functions.
 */
TestSuite(tc_tvwo_test05tvw,
        .init = setup,
        .fini = teardown);

/**
 * Create the file contents.
 *
 * test05.tvw contains wrong metadata (invalid / not XML) -- so if
 * :kconfig:option:`CONFIG_TVWO_VALIDATE_XML` is set, we expect an error.
 */
Test(tc_tvwo_test05tvw, fileops) {
#ifdef CONFIG_TVWO_VALIDATE_XML
    cr_expect(eq(int, test05o.err, TVW_ERR_INV_META),
            "tvw_write did not detect invalid metadata in test05.tvw!");
#else  // !CONFIG_TVWIO_VALIDATE_XML
    cr_expect(eq(int, test05o.err, 0),
            "tvw_write returned non-zero error code!");
#endif
}

/**
 * Test the file contents.
 */
Test(tc_tvwo_test05tvw, contents) {
    FILE *test = fopen(test05o.file->filename, "r");
    fseek(test, 0L, SEEK_END);
    size_t filesize = ftell(test);
    fseek(test, 0L, SEEK_SET);
    uint8_t *actual = (uint8_t*)calloc(filesize, sizeof(uint8_t));
    fread(actual, sizeof(char), filesize, test);

#ifdef CONFIG_TVWO_VALIDATE_XML

    // nothing is expected to be in the file here
    uint8_t good[0];

#else

    uint8_t good[] = {
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc4, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x57, 0x8b,
0x00, 0xb8, 0xd1, 0x1c, 0xec, 0x17, 0xf1, 0x22, 0x81, 0x21, 0x15, 0x76, 0x69,
0x35, 0xa8, 0x34, 0xb7, 0xd8, 0xcf, 0xe9, 0x19, 0xfc, 0x9f, 0xe3, 0x68, 0xe6,
0x92, 0x24, 0x77, 0xcb, 0xe0, 0x4c, 0x63, 0x58, 0xbf, 0x91, 0xce, 0x1f, 0x31,
0xe1, 0x5d, 0xef, 0x83, 0x2a, 0xda, 0xb8, 0xfd, 0x86, 0xe6, 0x92, 0x0e, 0x06,
0xd0, 0xc0, 0xb3, 0x2e, 0x52, 0xd3, 0xc5, 0x23, 0x5f, 0x82, 0x54, 0x68, 0x69,
0x73, 0x20, 0x66, 0x69, 0x6c, 0x65, 0x27, 0x73, 0x20, 0x6c, 0x65, 0x6e, 0x67,
0x74, 0x68, 0x5f, 0x6f, 0x66, 0x5f, 0x63, 0x6f, 0x6e, 0x74, 0x65, 0x6e, 0x74,
0x73, 0x20, 0x68, 0x61, 0x73, 0x20, 0x62, 0x65, 0x65, 0x6e, 0x20, 0x61, 0x6c,
0x74, 0x65, 0x72, 0x65, 0x64, 0x20, 0x74, 0x6f, 0x20, 0x69, 0x6e, 0x64, 0x69,
0x63, 0x61, 0x74, 0x65, 0x20, 0x2a, 0x6c, 0x65, 0x73, 0x73, 0x2a, 0x20, 0x63,
0x6f, 0x6e, 0x74, 0x65, 0x6e, 0x74, 0x73, 0x20, 0x70, 0x72, 0x65, 0x73, 0x65,
0x6e, 0x74, 0x20, 0x74, 0x68, 0x61, 0x6e, 0x20, 0x74, 0x68, 0x65, 0x72, 0x65,
0x20, 0x61, 0x63, 0x74, 0x75, 0x61, 0x6c, 0x6c, 0x79, 0x20, 0x61, 0x72, 0x65,
0x2e, 0x1d, 0x48, 0x65, 0x6c, 0x6c, 0x6f, 0x2c, 0x20, 0x77, 0x6f, 0x72, 0x6c,
0x64, 0x21, 0x0a, 0x48, 0x65, 0x6c, 0x6c, 0x6f, 0x2c, 0x20, 0x77, 0x6f, 0x72,
0x6c, 0x64, 0x21, 0x20, 0x28, 0x78, 0x32, 0x29, 0x0a, 0x48, 0x65, 0x6c, 0x6c,
0x6f, 0x2c, 0x20, 0x77, 0x6f, 0x72, 0x6c, 0x64, 0x21, 0x20, 0x28 };

#endif

    cr_expect(eq(u8[filesize], actual, good),
            "unexpected file contents!");
}

